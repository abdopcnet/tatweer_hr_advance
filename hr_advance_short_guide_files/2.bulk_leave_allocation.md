# Bulk Leave Allocation

## Overview

Bulk Leave Allocation allows you to create Leave Allocation documents for multiple employees at once.

## Key Points

-   When creating a new Leave Allocation with `carry_forward=1`, the system automatically updates the previous Leave Allocation document
-   A new Leave Allocation document is created for the new period
-   The old Leave Allocation document's `carry_forwarded_leaves_count` field is updated automatically
-   The old Leave Allocation document's `modified` date is updated when new allocation is created

## Fields

### Main Fields

-   `company` (Link, Required): Company name
-   `leave_type` (Link, Required): Leave Type
-   `from_date` (Date, Required): Allocation start date
-   `to_date` (Date, Required): Allocation end date
-   `department` (Link, Optional): Filter employees by department

### Read-only Fields

-   `yearly_leave_type` (Check, Read-only, Default: 0): Fetched from `leave_type.custom_yearly_leave_type`

### Child Tables

-   `bulk_leave_allocation_table` (Table): Bulk Leave allocation Table
    -   Options: Bulk Leave allocation Table

### Child Table Fields (Bulk Leave allocation Table)

-   `employee` (Link, Required): Employee name
-   `employee_name` (Data, Read-only): Fetched from employee
-   `department` (Link, Read-only): Fetched from employee
-   `company` (Link, Read-only): Fetched from employee
-   `leave_type` (Link, Read-only): Leave Type
-   `from_date` (Date, Read-only): Allocation start date
-   `to_date` (Date, Read-only): Allocation end date
-   `new_leaves_allocated` (Float, Required): New leaves to allocate
-   `carry_forward` (Check, Default=1, Read-only): Enable carry forward
-   `total_leaves_allocated` (Float, Read-only): Total leaves (unused + new)

## Workflow

### Step 1: Create Bulk Leave Allocation

1. Go to Leave Allocation list view
2. Click "Bulk Allocation" button
3. Fill in:
    - `company`
    - `leave_type`
    - `from_date`
    - `to_date`
    - `department` (optional)

### Step 2: Get Active Employees

1. Click "ðŸ‘¥ Get Active Employees" button
2. System fetches active employees based on filters
3. Child table is populated with:
    - Employee details
    - Leave balances (if `carry_forward=1`)
    - Default values:
        - If `yearly_leave_type=0`: `carry_forward=0`, `new_leaves_allocated=0`
        - If `yearly_leave_type=1`: `carry_forward=1`, `new_leaves_allocated=total_leaves_allocated`

### Step 3: Review and Edit

-   Review employee list in child table
-   Edit `new_leaves_allocated` if needed
-   `carry_forward` is set based on `yearly_leave_type`

### Step 4: Create Leave Allocations

1. Click "Create Bulk Leave Allocations" button (appears when child table has rows)
2. System creates Leave Allocation documents for each employee
3. Each allocation is automatically submitted

## Important Notes

### Carry Forward Behavior

-   When `carry_forward=1`:
    -   System calculates `unused_leaves` from previous allocation
    -   `total_leaves_allocated = unused_leaves + new_leaves_allocated`
    -   Previous allocation's `carry_forwarded_leaves_count` is updated
    -   Previous allocation's `modified` date is updated
    -   This is normal system behavior

### Yearly Leave Type

-   If `yearly_leave_type=1`:
    -   `new_leaves_allocated` is automatically set to `total_leaves_allocated`
    -   `new_leaves_allocated` is not mandatory
-   If `yearly_leave_type=0`:
    -   `new_leaves_allocated` must be entered manually
    -   `new_leaves_allocated` is mandatory

### Duplicate Prevention

-   System checks for existing allocations with same:
    -   `employee`
    -   `leave_type`
    -   `from_date`
    -   `to_date`
-   If exists, creation is skipped with error message

### Old Document Update

-   When creating new allocation with `carry_forward=1`:
    -   Previous allocation document is automatically updated
    -   `carry_forwarded_leaves_count` field is set
    -   `modified` date is updated
    -   This is normal system behavior

## Example Scenario

1. Employee has Leave Allocation for 2025-10-01 to 2025-12-31
2. Create Bulk Leave Allocation for 2026-01-01 to 2026-12-31
3. System:
    - Creates new Leave Allocation (2026 period)
    - Updates old Leave Allocation (2025 period) with `carry_forwarded_leaves_count`
    - Both documents are linked via Leave Ledger Entry
    - Old allocation's `modified` date is updated

## Troubleshooting

### Cannot Cancel Leave Allocation

-   If Leave Allocation is linked to Leave Applications, it cannot be cancelled
-   Cancel Leave Applications first, then cancel Leave Allocation

### Duplicate Allocations

-   System prevents duplicate allocations for same period
-   Check existing allocations before creating new ones

### Modified Date Updated

-   Old allocation's `modified` date is updated when new allocation with carry forward is created
-   This is expected behavior
